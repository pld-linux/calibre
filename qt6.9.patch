From 30b66dc452d3c08c7e10cc95498e131348d7bbfb Mon Sep 17 00:00:00 2001
From: Kovid Goyal <kovid@kovidgoyal.net>
Date: Sat, 5 Apr 2025 02:59:58 +0530
Subject: [PATCH] Linux: Fix building with Qt 6.9

---
 src/calibre/headless/headless_integration.cpp | 6 ++++++
 src/calibre/headless/headless_integration.h   | 1 -
 2 files changed, 6 insertions(+), 1 deletion(-)

diff --git a/src/calibre/headless/headless_integration.cpp b/src/calibre/headless/headless_integration.cpp
index a5dfc869cc66..e96ddeef80fa 100644
--- a/src/calibre/headless/headless_integration.cpp
+++ b/src/calibre/headless/headless_integration.cpp
@@ -27,7 +27,13 @@ QT_BEGIN_NAMESPACE
 
 
 #ifndef __APPLE__
+#if QT_VERSION < QT_VERSION_CHECK(6, 9, 0)
+#include <QtGui/private/qgenericunixservices_p.h>
 class GenericUnixServices : public QGenericUnixServices {
+#else
+#include <QtGui/private/qdesktopunixservices_p.h>
+class GenericUnixServices : public QDesktopUnixServices {
+#endif
     /* We must return desktop environment as UNKNOWN otherwise other parts of
      * Qt will try to query the nativeInterface() without checking if it exists
      * leading to a segfault.  For example, defaultHintStyleFromMatch() queries
diff --git a/src/calibre/headless/headless_integration.h b/src/calibre/headless/headless_integration.h
index f8705facffe8..604669677da4 100644
--- a/src/calibre/headless/headless_integration.h
+++ b/src/calibre/headless/headless_integration.h
@@ -3,7 +3,6 @@
 #include <qpa/qplatformintegration.h>
 #include <qpa/qplatformscreen.h>
 #include <qpa/qplatformservices.h>
-#include <QtGui/private/qgenericunixservices_p.h>
 #include <QScopedPointer>
 
 QT_BEGIN_NAMESPACE
--- calibre-6.23.0/src/calibre/headless/CMakeLists.txt.orig	2023-07-14 03:29:18.000000000 +0200
+++ calibre-6.23.0/src/calibre/headless/CMakeLists.txt	2026-01-24 21:08:55.160236875 +0100
@@ -2,6 +2,9 @@
 cmake_minimum_required(VERSION 3.21)
 set(CMAKE_AUTOMOC ON)
 find_package(Qt6Gui REQUIRED)
+if (Qt6Gui_VERSION VERSION_GREATER_EQUAL "6.10.0")
+	find_package(Qt6GuiPrivate REQUIRED NO_MODULE)
+endif()
 add_library(headless MODULE main.cpp headless_backingstore.cpp headless_integration.cpp)
 set_property(TARGET headless PROPERTY QT_PLUGIN_TYPE "platforms")
 set_property(TARGET headless PROPERTY QT_PLUGIN_CLASS_NAME "HeadlessIntegrationPlugin")
